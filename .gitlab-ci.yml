# ==============================
# GitLab CI/CD â€“ Optimized for Self-Hosted VPS Runner
# ==============================
image: node:20-alpine

stages:
  - build
  - test
  - deploy

variables:
  NODE_ENV: production
  CI: 'true'

# Single cache definition (only one in the entire file!)
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .next/cache/
  policy: pull-push

# -------------------------------
# Build
# -------------------------------
build:
  stage: build
  tags:
    - vps
  script:
    - echo "Installing dependencies..."
    - npm ci --prefer-offline --no-audit
    - echo "Generating Prisma client..."
    - npx prisma generate
    - echo "Building Next.js app..."
    - npm run build
  artifacts:
    paths:
      - .next/
      - node_modules/
      - prisma/
      - public/
      - package.json
      - package-lock.json
      - ecosystem.config.js
      - .env.production
      - .env.staging
    expire_in: 2 hours
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

# -------------------------------
# Lint
# -------------------------------
test:lint:
  stage: test
  tags:
    - vps
  script:
    - npm run lint || echo "Lint warnings (non-blocking)"
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

# -------------------------------
# Deploy Production
# -------------------------------
deploy_production:
  stage: deploy
  tags:
    - vps
  dependencies:
    - build
  timeout: 20m
  script: |
    echo "Deploying to production..."
    rsync -avz --delete \
      --exclude='.git' \
      --exclude='.env*' \
      -e "ssh -o StrictHostKeyChecking=no" \
      ./ $VPS_USER@$VPS_HOST:$VPS_DEPLOY_PATH/

    ssh $VPS_USER@$VPS_HOST << 'EOF'
      cd $VPS_DEPLOY_PATH
      cp .env.production .env
      export NODE_ENV=production
      npx prisma migrate deploy
      mkdir -p public/uploads && chmod 755 public/uploads
      pm2 reload ecosystem.config.js --env production || \
        (pm2 delete ecosystem.config.js 2>/dev/null || true; pm2 start ecosystem.config.js --env production)
      pm2 save
      sleep 5
      curl -f http://localhost:3002 || exit 1
      echo "Production deployed & healthy!"
    EOF
  environment:
    name: production
    url: https://careandcleannp.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# -------------------------------
# Deploy Staging (Manual)
# -------------------------------
deploy_staging:
  stage: deploy
  tags:
    - vps
  dependencies:
    - build
  timeout: 20m
  when: manual
  script: |
    echo "Deploying to staging..."
    rsync -avz --delete \
      --exclude='.git' \
      --exclude='.env*' \
      -e "ssh -o StrictHostKeyChecking=no" \
      ./ $VPS_USER@$VPS_HOST_STAGING:$VPS_DEPLOY_PATH_STAGING/

    ssh $VPS_USER@$VPS_HOST_STAGING << 'EOF'
      cd $VPS_DEPLOY_PATH_STAGING
      cp .env.staging .env
      export NODE_ENV=staging
      npx prisma migrate deploy
      mkdir -p public/uploads && chmod 755 public/uploads
      pm2 reload ecosystem.config.js --env staging || \
        (pm2 delete ecosystem.config.js 2>/dev/null || true; pm2 start ecosystem.config.js --env staging)
      pm2 save
      sleep 5
      curl -f http://localhost:3002 || exit 1
      echo "Staging deployed & healthy!"
    EOF
  environment:
    name: staging
    url: https://staging.careandcleannp.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual
