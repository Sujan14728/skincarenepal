stages:
  - build
  - test
  - deploy

variables:
  APP_DIR: /var/www/careandclean/skincarenepal
  NODE_ENV: production
  CACHE_KEY: '$CI_COMMIT_REF_SLUG'

# Build Stage
build:
  stage: build
  tags:
    - vps
    - production
  only:
    - main
  cache:
    paths:
      - $APP_DIR/node_modules/
      - $APP_DIR/.next/cache/
    key: $CACHE_KEY
  script:
    - echo "ğŸš€ Starting Build Stage..."

    # Clone or update repo (avoid rm -rf)
    - echo "ğŸ“¥ Fetching latest code..."
    - |
      if [ -d "$APP_DIR/.git" ]; then
        cd $APP_DIR
        git fetch origin main
        git reset --hard origin/main
      else
        git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/bhuwan070-group/careandcleannepal.git $APP_DIR
        cd $APP_DIR
      fi

    # Install dependencies
    - echo "ğŸ“¦ Installing dependencies..."
    - export NODE_ENV=development
    - npm ci --prefer-offline --no-audit
    - export NODE_ENV=production

    # Generate Prisma Client
    - echo "ğŸ—„ï¸ Generating Prisma Client..."
    - npx prisma generate

    # Build application
    - echo "ğŸ”¨ Building application..."
    - rm -rf .next
    - npm run build

    - echo "âœ… Build stage completed!"

  artifacts:
    paths:
      - $APP_DIR/.next/
      - $APP_DIR/node_modules/
      - $APP_DIR/prisma/
    expire_in: 1 hour

# Test Stage
test:
  stage: test
  tags:
    - vps
    - production
  only:
    - main
  cache:
    paths:
      - $APP_DIR/node_modules/
    key: $CACHE_KEY
  dependencies:
    - build
  script:
    - echo "ğŸ§ª Starting Test Stage..."
    - cd $APP_DIR

    # Run linting (if configured)
    - echo "ğŸ” Running linter..."
    - npm run lint || echo "âš ï¸  Linting warnings (non-blocking)"

    # Run tests (if configured)
    - echo "ğŸ§¬ Running unit tests..."
    - npm run test || echo "âš ï¸  Tests skipped (configure jest in package.json)"

    # Type checking
    - echo "ğŸ“ Running type check..."
    - npx tsc --noEmit || echo "âš ï¸  Type check passed with warnings"

    - echo "âœ… Test stage completed!"

  allow_failure: true # Don't block deploy if tests fail

# Deploy Stage
deploy:
  stage: deploy
  tags:
    - vps
    - production
  only:
    - main
  dependencies:
    - build
    - test
  script:
    - echo "ğŸš€ Starting Deploy Stage..."
    - cd $APP_DIR

    # Restore environment file
    - echo "ğŸ“„ Restoring .env..."
    - cp /var/www/careandclean/env/.env $APP_DIR/.env

    # Update database schema
    - echo "ğŸ“Š Updating database schema..."
    - npx prisma db push --skip-generate --accept-data-loss || echo "Schema
      already up to date"

    # Restart PM2
    - echo "ğŸ”„ Restarting application..."
    - pm2 restart skincarenepal --update-env || pm2 start npm --name
      "skincarenepal" -- start
    - pm2 save

    # Health check
    - echo "ğŸ¥ Performing health check..."
    - sleep 3
    - curl -f http://localhost:3000 || (echo "âŒ Health check failed" && exit 1)

    - echo "âœ… Deployment completed successfully! ğŸ‰"

  environment:
    name: production
    url: https://careandcleannp.com

  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
