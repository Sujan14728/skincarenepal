stages:
  - deploy

variables:
  APP_DIR: /var/www/careandclean/skincarenepal
  NODE_ENV: production

build_and_deploy:
  stage: deploy
  tags:
    - vps
    - production
  only:
    - main
  script:
    - echo "ğŸš€ Starting deployment on VPS..."

    # Fresh clone with CI_JOB_TOKEN to ensure auth works on VPS
    - echo "ğŸ“¥ Fetching latest code (fresh clone)..."
    - rm -rf $APP_DIR
    - git clone
      https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/bhuwan070-group/careandcleannepal.git
      $APP_DIR
    - cd $APP_DIR

    # Clean node_modules
    - echo "ğŸ§¹ Cleaning node_modules..."
    - rm -rf node_modules

    # Install dependencies (including dev)
    - echo "ğŸ“¦ Installing dependencies..."
    - export NODE_ENV=development
    - npm ci --prefer-offline --no-audit
    - export NODE_ENV=production

    # Prisma
    - echo "ğŸ—„ï¸ Generating Prisma Client..."
    - npx prisma generate
    - echo "ğŸ“Š Updating database schema..."
    - npx prisma db push --skip-generate --accept-data-loss || echo "Schema
      already up to date"

    # Build
    - echo "ğŸ”¨ Building application..."
    - rm -rf .next
    - npm run build

    # Restart PM2
    - echo "ğŸ”„ Restarting application..."
    - pm2 restart skincarenepal --update-env || pm2 start npm --name
      "skincarenepal" -- start
    - pm2 save

    # Health check
    - echo "ğŸ¥ Performing health check..."
    - sleep 5
    - 'curl -f http://localhost:3000 || echo "Warning: Health check failed"'

    - echo "âœ… Deployment completed successfully! ğŸ‰"

  environment:
    name: production
    url: https://careandcleannp.com

  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
