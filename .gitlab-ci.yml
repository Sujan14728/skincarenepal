# ==============================
# GitLab CI/CD â€“ Self-Hosted VPS Runner (Direct Deployment)
# ==============================

stages:
  - deploy

variables:
  APP_DIR: /var/www/careandclean/skincarenepal
  NODE_ENV: production

# -------------------------------
# Build and Deploy (Combined for VPS Runner)
# -------------------------------
build_and_deploy:
  stage: deploy
  tags:
    - vps
    - production
  only:
    - main
  script:
    - echo "ğŸš€ Starting deployment on VPS..."

    # Navigate to app directory
    - cd $APP_DIR

    # Pull latest changes
    - echo "ğŸ“¥ Pulling latest code..."
    - git fetch origin
    - git reset --hard origin/main

    # Clean node_modules if it exists with permission issues
    - echo "ğŸ§¹ Cleaning node_modules..."
    - rm -rf node_modules || sudo rm -rf node_modules

    # Install dependencies (temporarily unset NODE_ENV to include devDependencies)
    - echo "ğŸ“¦ Installing dependencies..."
    - export NODE_ENV=development
    - npm ci --prefer-offline --no-audit
    - export NODE_ENV=production

    # Generate Prisma Client
    - echo "ğŸ—„ï¸ Generating Prisma Client..."
    - npx prisma generate

    # Push database schema (if changes exist)
    - echo "ğŸ“Š Updating database schema..."
    - npx prisma db push --skip-generate --accept-data-loss || echo "Schema
      already up to date"

    # Clean previous build artifacts
    - echo "ğŸ§¹ Cleaning previous build..."
    - rm -rf .next || sudo rm -rf .next

    # Build Next.js application
    - echo "ğŸ”¨ Building application..."
    - npm run build

    # Restart PM2
    - echo "ğŸ”„ Restarting application..."
    - pm2 restart skincarenepal --update-env || pm2 start npm --name
      "skincarenepal" -- start
    - pm2 save

    # Health check
    - echo "ğŸ¥ Performing health check..."
    - sleep 5
    - 'curl -f http://localhost:3002 || echo "Warning: Health check failed"'

    - echo "âœ… Deployment completed successfully! ğŸ‰"

  environment:
    name: production
    url: https://careandcleannp.com

  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
